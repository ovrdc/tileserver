<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.10.13/css/dataTables.bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,800" rel="stylesheet">
  <style>
    * {
      font-family: "Open Sans", "Segoe UI", sans-serif;
    }

    a,
    th {
      color: #5cb85c;
    }

    b,
    strong {
      font-weight: 600;
    }

    a:hover,
    a:focus {
      color: #449d44;
    }

    .pagination>.active>a,
    .pagination>.active>a:focus,
    .pagination>.active>a:hover,
    .pagination>.active>span,
    .pagination>.active>span:focus,
    .pagination>.active>span:hover {
      background-color: #5cb85c;
      border-color: #5cb85c;
    }

    @media screen and (max-width: 767px) {
      label,
      .pagination,
      div.dataTables_info {
        width: 100%;
        float: left;
        text-align: left!important;
      }
    }

    @media screen and (max-width:600px) {
      thead {
        display: none;
      }

      table.cards {
        background-color: transparent;
        border: none;
        padding: 10px 10px 10px 0;
      }

      .cards td,
      .cards tr,
      .cards tbody {
        width: 100%;
      }

      /*--[  This does the job of making the table rows appear as cards ]----------------*/
      .cards tbody img {
        height: 100px;
      }
      .cards td:nth-child(1) {
        border-top: none;
      }
      .cards tbody tr {
        float: left;
        margin-bottom: 20px;
        border: 1px solid #ddd;
        box-shadow: 3px 3px 8px rgba(0, 0, 0, .05);
        background-color: white!important;
        /*padding: 8px;*/
        border-radius: 4px;
      }
      .cards tbody td {
        padding: 10px!important;
        display: block;
        width: -webkit-calc(100% - 20px);
        width: -moz-calc(100% - 20px);
        width: calc(100% - 20px);
        overflow: hidden;
        text-align: left;
        margin: 5px 0;
        border-right-width: 0!important;
      }

      .table tbody label {
        display: none;
        margin-right: 5px;
        width: 50px;
      }
      .table .glyphicon {
        font-size: 20px;
      }

      .cards .glyphicon {
        font-size: 75px;
      }

      .cards tbody label {
        display: inline;
        position: relative;
        font-size: 85%;
        font-weight: normal;
        top: -5px;
        left: -3px;
        float: left;
        color: #808080;
      }
      .cards tbody td:nth-child(1) {
        text-align: center;
      }
    }

    body {
      padding-top: 10px;
    }

    .navbar-toggle .icon-bar {
      background-color: #5cb85c;
    }

    .navbar-toggle {
      background-color: #eee;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    .vcenter {
      display: inline-block;
      vertical-align: middle;
      float: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <nav class="navbar">
      <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false" style="display:none;">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">OVRDC Tileserver</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <!--li><a href="#">Link</a></li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Dropdown <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="#">Action</a></li>
            <li><a href="#">Another action</a></li>
            <li><a href="#">Something else here</a></li>
            <li role="separator" class="divider"></li>
            <li><a href="#">Separated link</a></li>
            <li role="separator" class="divider"></li>
            <li><a href="#">One more separated link</a></li>
          </ul>
        </li-->
          </ul>
          <!--form class="navbar-form navbar-left">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search">
        </div>
        <button type="submit" class="btn btn-default">Submit</button>
      </form-->
          <ul class="nav navbar-nav navbar-right">
            <!--li>
              <a id="data" href="#">DATA</a>
            </li>
            <li>
              <a id="stats" href="#">STATS</a>
            </li-->
            <!--li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Dropdown <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="#">Action</a></li>
            <li><a href="#">Another action</a></li>
            <li><a href="#">Something else here</a></li>
            <li role="separator" class="divider"></li>
            <li><a href="#">Separated link</a></li>
          </ul>
        </li-->
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
      <!-- /.container-fluid -->
    </nav>
    <div id="statsDiv" style="display:none;">
      <div class="jumbotron">
        <h1>Server Statistics</h1>
      </div>
      <div class="jumbotron">
        <div class="row">
          <div class="col-sm-4 col-lg-4 text-center">
            <h3>Server Space</h3>
            <canvas id="driveChartDiv2" width="320" height="269"></canvas>
          </div>
          <div class="col-sm-4 col-lg-4 text-center" style="height:320px;">
            <h3>Requests</h3>
            <h1 id="requestsDiv2" class="jumbotron vcenter" style="padding-top:60px;">10</h1>
          </div>
          <div class="col-sm-4 col-lg-4 text-center">
            <h3>Memory</h3>
            <canvas id="memChartDiv2" width="320" height="269"></canvas>
          </div>
        </div>
      </div>
    </div>
    <div id="dataDiv">
      <div class="jumbotron" style="padding-top:20px;padding-bottom:40px;">
        <div class="row">
          <div class="col-sm-4 col-lg-4 text-center">
            <p>Server Space</p>
            <canvas id="driveChartDiv" width="320" height="120"></canvas>
          </div>
          <div class="col-sm-4 col-lg-4 text-center" style="min-height:10px;">
            <p>Requests</p>
            <h1 id="requestsDiv" class="" style="padding-top:20px;">10</h1>
          </div>
          <div class="col-sm-4 col-lg-4 text-center">
            <p>Memory</p>
            <canvas id="memChartDiv" width="320" height="120"></canvas>
          </div>
        </div>
        <!--div>
          <h1>Available Data</h1>
          <p><a href="https://maputnik.github.io/editor" target="_blank">Maputnik Editor</a></p>
          <em>To style data in Maputnik, copy the tilejson link and paste into Maputnik as a 'source'. Take note of the tile and layer name first.</em>
          <br><br>
        </div-->
      </div>
      <div class="">
        <table id="example" class="table table-striped table-bordered cards" cellspacing="0" width="100%">
          <thead>
            <tr>
              <th>File Name & Description</th>
              <th>Size (MB)</th>
              <th>Type</th>
              <th>
                Preview
              </th>
            </tr>
          </thead>
          <!--tfoot>
                <tr>
                    <th>Name</th>
                    <th>Position</th>
                    <th>Office</th>
                    <th>Age</th>
                    <th>Start date</th>
                    <th>Salary</th>
                </tr>
            </tfoot-->
          <tbody id="table">
          </tbody>
        </table>
        <div class="alert alert-info">
          <p><a href="https://maputnik.github.io/editor" target="_blank"><strong>Maputnik Editor</strong></a> To style data in Maputnik, copy the tilejson link and paste into Maputnik as a 'source'. Take note of the tile and layer name first.</p>
        </div>
      </div>
    </div>
    <div id="todoDiv" style="display:none;">
      <h3>To Do:</h3>
      <ul>
        <li>When uploading mbtiles, also upload the original geojson file, and add that as a 'download' link or convert lowest level of mbtile back to geojson.</li>
        <li>Add a link to a very simple style to edit directly in Maputnik or just change the preview tab to be Maputnik!</li>
        <li>Figure out a way to get some sort of preview image for the tiles?</li>
      </ul>
    </div>
  </div>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.13/js/dataTables.bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.0/Chart.bundle.min.js" integrity="sha256-OHkZxrR7EXZQ8MlUC+Ww2+RedaJSP6DEsAukSt023dU=" crossorigin="anonymous"></script>
<script src="assets/js/countup.js"></script>
<script>
  var metadata, driveChart, driveChartData, memChartData;
  $(document).ready(function() {
    $.ajaxSetup({
      cache: false
    });
    $("#statsDiv").hide();
    $(".nav a").on('click',function(e) {
      event.preventDefault();
      if (this.id === 'data') {
        $("#statsDiv").hide();
        $("#dataDiv").fadeIn("slow");
      }else{
        $("#dataDiv").hide();
        $("#statsDiv").fadeIn("slow");
        getChartData();
      }
    });

    $.getJSON('meta/metadata.json', function(data) {
      //console.log('metadata:', data);
      metadata = data;
      for (i = 0; i < data.length; i++) {
        if (data[i] && (data[i].vector_layers || data[i].name)) {
          /*console.log(i);*/
          var type = data[i].format;
          if (type == "pbf") {
            var layer = data[i].vector_layers[0].id;
            var layers = data[i].vector_layers;
            var layerIds = [];
            /*console.log('layers: ', layers);*/
            //console.log((data[i].vector_layers).length);
            for (var l = 0; l < layers.length; l++) {
              /*console.log(layers[l].id);*/
              if (layers[l].id) {
                layerIds.push(layers[l].id);
              }
            }
            /*console.log(layerIds.toString());*/
          }
          if (type == "jpg" || type == "jpeg" || type == "JPG" || type == "JPEG" || type == "png" || type == "PNG") {
            var layer = data[i].id;
          }
          var fileName = ((data[i].basename).split("."));
          var name = fileName[0];
          if (data[i].name) {
            name = data[i].name;
          }
          var bounds = data[i].bounds;
          var center = data[i].center;
          var about = data[i].description;
          var maxzoom = data[i].maxzoom;
          //var size = ((data[i].filesize)/1000000).toFixed(2);
          var format = "";
          var size = ((data[i].filesize) / 1000000).toFixed(2);
          $("#table").append("<tr><td><strong style='font-size:larger;'>" + name + "</strong><br /><em>" + about + "</em></td><td style='min-width: 80px;'>" + size + " MB</td><td>" + type +
            "</td><td><a class='btn btn-success btn-sm' style='width:100%;margin-top:4px;' href='preview/map.html?format=" + type + "&tile=" + fileName[0] + "&layer=" + layer + "&layers=" + layerIds.toString() + "&bounds=" + bounds +
            "&center=" + center + "&maxzoom=" + maxzoom + "' target='_blank'>Preview</a> \
        <br><a style='text-align: center;' href='/meta/" + fileName[0] + "-metadata.json'>Metadata</a>&nbsp;<a href='/meta/" + fileName[0] +
            "-tilejson.json'>Tilejson</a></td></tr>");
        }
      }
      $('#example').DataTable({
        "iDisplayLength": 7
      });
    });
    var x = 0;

    function getChartData() {
      var ts = new Date().getTime();
      var ts = new Date().getTime();
      var data = {
        _: ts
      };
      var url = 'meta/space.json';
      $.getJSON('meta/space.json', data)
        .done(function(data) {
          console.log(data);
          var chartData = {};
          for (var key in data[0]) {
            if (data[0].hasOwnProperty(key)) {
              chartData[key] = Number(data[0][key])
            }
          }
          drawCharts(chartData);
        });
    }

    function drawCharts(d) {
      var used = (d.totalspace - d.freespace).toFixed(2)
      /*driveChartData = [{
          label: "Free Space (GB)",
          color: "#5cb85c",
          value: [(d.freespace).toFixed(2)]
        },
        {
          label: "Used Space (GB)",
          color: "hsl(348, 100%, 61%)",
          value: [used]
        }
      ];*/
      driveChartData = {
        labels: ["Free", "Used"],
        datasets: [{
          label: "Hard Drive Space",
          //color: "#5cb85c",
          backgroundColor: ["#5cb85c", "hsl(348, 100%, 61%)"],
          data: [Number((d.freespace).toFixed(2)), Number(used)]
        }]
      };
      var currentMemory = 1000 - d.memory;
      memChartData = {
        labels: ["Free", "Used"],
        datasets: [{
          label: "Memory",
          //color: "#5cb85c",
          backgroundColor: ["hsl(204, 86%, 53%)", "hsl(48, 100%, 67%)"],
          data: [currentMemory, d.memory]
        }]
      }
      Chart.defaults.global.animation.duration = 1800;
      Chart.defaults.global.animation.easing = 'easeInOutCubic';
      driveChart = new Chart(document.getElementById("driveChartDiv").getContext("2d"), {
        type: 'doughnut',
        data: driveChartData,
        options: {
          animation: {
            animateScale: true
          },
          legend: {
            display: false
          }
        }
      });
      memChart = new Chart(document.getElementById("memChartDiv").getContext("2d"), {
        type: 'doughnut',
        data: memChartData,
        options: {
          animation: {
            animateScale: true
          },
          legend: {
            display: false
          }
        }
      });
      console.log(d.requests);
      var count = new CountUp('requestsDiv', 0, d.requests);
      count.start();
      //$("#requestsDiv").html(d.requests)
    }
    getChartData();
  });
</script>

</html>
