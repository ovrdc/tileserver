<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>OVRDC Tileserver Preview</title>
  <script src='https://api.mapbox.com/mapbox-gl-js/v0.39.1/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v0.39.1/mapbox-gl.css' rel='stylesheet' />
  <script src='mapbox-gl-inspect.js'></script>
  <link href='mapbox-gl-inspect.css' rel='stylesheet' />
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
  <style>

    body {
      background: #fff;
      color: #333;
      margin: 0;
      font-family: "Segoe UI", "Lato", sans-serif;
    }

    #map {
      position: absolute;
      top: 0;
      left: 0;
      right: 30%;
      bottom: 0;
    }

    #sidebar {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: 30%;
      z-index: 9999;
      overflow: auto;
      border-left: thin solid lightgray;
    }

    h3,
    h6 {
      margin: 8px;
    }

    #layerList,
    #propertyList {
      margin: 8px;
    }

    #layerList div div {
      width: 15px;
      height: 15px;
      display: inline-block;
    }

    .inner {
      padding: 10px;
    }

    #map canvas {
      cursor: crosshair;
    }

    #loader {
      background: white;
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 100%;
      z-index: 9998;
    }

    .loader-fadeout {
      -webkit-transition: opacity 0.3s ease-in-out;
      -moz-transition: opacity 0.3s ease-in-out;
      -ms-transition: opacity 0.3s ease-in-out;
      -o-transition: opacity 0.3s ease-in-out;
      opacity: 0;
      z-index: 0!important;
    }

    #loader-img {
      background: white;
      position: absolute;
      z-index: 9999;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
  </style>
</head>

<body>
  <div id="map">
    <div id="loader">
      <div id="loader-img"><img src="hex-loader2.gif" /></div>
    </div>
  </div>
  <div id="sidebar">
    <div class="inner">
      <h3>OVRDC Tile Preview</h3>
      <h6><a href="/">Return to the OVRDC Tileserver</a></h6>
      <div id="layerList"></div>
      <pre id="propertyList"></pre>
    </div>
  </div>
  <script>
    var getQuery = function(q) {
      if (q) {
        var params = {},
          queries, temp, i, l;
        // Split into key/value pairs
        queries = q.split("&");
        // Convert the array of strings into an object
        for (i = 0, l = queries.length; i < l; i++) {
          temp = queries[i].split('=');
          params[temp[0]] = temp[1];
        }
        return params;
      }
    };

    var query = getQuery((window.location.search).substring(1));

    //console.log(query);
    var tileUrl, layers, tile, center, format, maxzoom, tile1, tile2, tile3, layer;
    format = query.format;
    layer = query.layer;
    layers = query.layers;
    var layersArray = layers.split(",");
    //console.log(layersArray[0].toString());
    tile = query.tile;
    bounds = (query.bounds).split(",");
    center = (query.center).split(",");
    maxzoom = Number(query.maxzoom);
    tile1 = "https://174.138.45.93/" + tile + "/{z}/{x}/{y}." + format;
    /*    tile1 = "https://a.tiles.ovrdc.org/" + tile + "/{" + "z" + "}/" + "{x}/{y}." + format;
        tile2 = "https://b.tiles.ovrdc.org/" + tile + "/{" + "z" + "}/" + "{x}/{y}." + format;
        tile3 = "https://c.tiles.ovrdc.org/" + tile + "/{" + "z" + "}/" + "{x}/{y}." + format;*/
    //console.log(unescape(tiles));
    var map = new mapboxgl.Map({
      container: 'map',
      hash: false,
      style: 'blank.json',
      attributionControl: true,
      pitch: 0,
      bearing: 0,
      center: [center[0], center[1]],
      zoom: 8,
      /*debug: true,*/
      hash: true,
      maxZoom: 22,
      minZoom: 6
      /*maxBounds: [
        [bounds[0], bounds[1]],
        [bounds[2], bounds[3]]
      ]*/
    });
    map.addControl(new mapboxgl.NavigationControl());

    map.on('load', function() {
      buildMap();
      document.getElementById('layerList').innerHTML = '<pre>Current Zoom Level: '+ (map.getZoom()).toFixed(2) + '</pre>';
    });

    function buildMap() {
      if (format == "pbf") {
        var mapLayers = [
          {
            "id": "background",
            "type": "background",
            "paint": {
              "background-color": "white"
            }
          }
        ];
        for (var l=0; l < layersArray.length; l++) {
          //console.log(layersArray[l]);
          /*lines do not play well with type: fill*/
          if (layersArray[l] == 'waterway' || layersArray[l] == 'transportation' || layersArray == 'boundary') {
            mapLayers.push({
              "id": layersArray[l] + l,
              "type": "line",
              "source": "preview",
              "source-layer": layersArray[l]
            });
          }
          if (layersArray[l] != 'transportation_name' && layersArray != 'water_name' && layersArray[l] != 'waterway' && layersArray[l] != 'transportation' && layersArray[l] != 'boundary') {
            mapLayers.push({
              "id": layersArray[l] + l,
              "type": "fill",
              "source": "preview",
              "source-layer": layersArray[l],
              "paint": {
                "fill-color": "whitesmoke"
              }
            },
            {
              "id": layersArray[l] + l + 1,
              "type": "line",
              "source": "preview",
              "source-layer": layersArray[l],
              "paint": {
                "line-color": "orange"
              }
            },
            {
              "id": layersArray[l] + l + 2,
              "type": "circle",
              "source": "preview",
              "source-layer": layersArray[l],
              "paint": {
                "circle-radius": {
                  "stops": [
                    [0,0],
                    [13, 1],
                    [19,8]
                  ]
                },
                "circle-color": "orange"
              }
            });
          }
        }
        console.log(mapLayers);
        map.setStyle({
        	"version": 8,
        	"name": "blank",
        	"sources": {
        		"openmaptiles": {
        			"type": "vector",
        			"url": ""
        		},
            'preview': {
              "type": "vector",
              "tiles": [tile1],
              //tile2, tile3],
              "maxzoom": maxzoom
            }
        	},
        	"layers": mapLayers
        });
        map.addControl(new MapboxInspect({
          showInspectMap: true,
          showInspectButton: false,
          selectThreshold: 10,
          showMapPopup: true,
          showMapPopupOnHover: false,
          showInspectMapPopupOnHover: false
        }));

/*        map.addSource('preview', {
          "type": "vector",
          "tiles": [tile1],
          // tile2, tile3],
          "maxzoom": maxzoom
        });*/
        //console.log(map.getSource('preview'));
        /*for (var i=0; i<mapLayers.length; i++) {
          var polygon = "previewPolygon" + i;
          polygon = {
            "id": polygon,
            "type": "fill",
            "source": "preview",
            "source-layer": mapLayers[i].id,
            "paint": {
              "fill-color": "#333"
            },
            "interactive": true,
          };
          map.addLayer(polygon);
        }*/
        /*var previewPolygon = {
          "id": "previewPolygon",
          "type": "fill",
          "source": "preview",
          "source-layer": layer,
          "layout": {
            "visibility": "visible"
          },
          "paint": {
            "fill-color": "white"
          },
          "interactive": true,
        };
        map.addLayer(previewPolygon);
        var previewLine = {
          "id": "previewLine",
          "type": "line",
          "source": "preview",
          "source-layer": layer,
          "layout": {
            "visibility": "visible"
          },
          "interactive": true,
        };
        map.addLayer(previewLine);
        var previewCircle = {
          "id": "previewCircle",
          "type": "circle",
          "source": "preview",
          "source-layer": layer,
          "layout": {
            "visibility": "visible"
          },
          "paint": {
            "circle-radius": 3,
            "circle-color": "orange"
          },
          "interactive": true,
        };
        map.addLayer(previewCircle);*/

        /*map.addLayer({
        	"id": "highlightLayer",
        	"type":"fill",
        	"source": "preview",
            "source-layer": layer,
        	"layout":{},
        	"paint": {
        		"fill-color":"goldenrod",
        		"fill-opacity":0
        	}
        });*/
        map.on('click', function(e) {
          var features = map.queryRenderedFeatures(e.point);
          if (features.length) {

            /*			map.setPaintProperty("highlightLayer","fill-opacity", 0.8);*/
            /*var id = features[0].properties[0];
            map.setPaintProperty("previewPolygon", "fill-color", {"type": "categorical", "property": "id", "stops": [
              [0, "red"], [22021, "white"]
            ]});*/
            //document.getElementById('layerList').innerHTML = layers;
            document.getElementById('propertyList').innerHTML = JSON.stringify(features, null, 2);
          }
        });
      } else {
        map.addSource("raster-tiles", {
          "type": "raster",
          "tiles": [tile1],// tile2, tile3],
          "tileSize": 256,
          "maxzoom": maxzoom
        });
        var rasterTilePreview = {
          "id": "rasterTilePreview",
          "type": "raster",
          "source": "raster-tiles"
        };
        map.addLayer(rasterTilePreview);
      }
      setTimeout(function() {
        document.getElementById('loader').className = "loader-fadeout";
      }, 500);
      map.on('zoomend', function() {
        document.getElementById('layerList').innerHTML = '<pre>Current Zoom Level: '+ (map.getZoom()).toFixed(2) + '</pre>';
      })
    }
  </script>
</body>

</html>
